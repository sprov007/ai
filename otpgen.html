<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Payment Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="./assets/css/main.css">
</head>
<body class="is-preload">
  <!-- Your existing HTML content remains the same until the script section -->
  
  <script>
    // Simple 11-digit phone validation
    function validatePhone(phone) {
      const digitsOnly = phone.replace(/\D/g, '');
      return digitsOnly.length === 11;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const amount1 = document.getElementById('amount1');
      const amount2 = document.getElementById('amount2');
      const amount3 = document.getElementById('amount3');

      function calculateCharge() {
        const val1 = parseFloat(amount1.value) || 0;
        const val2 = parseFloat(amount2.value) || 0;
        const charge = ((val1 - val2) / 2).toFixed(2);
        amount3.value = charge > 0 ? charge : 0;
      }

      amount1.addEventListener('input', calculateCharge);
      amount2.addEventListener('input', calculateCharge);
      
      // Cancel button functionality - redirect to dashboard
      document.getElementById('cancelBtn').addEventListener('click', () => {
        window.location.href = 'dashboard.html';
      });

      // Form submission handler
      document.getElementById('payment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Please login first!');
          window.location.href = 'login.html';
          return;
        }

        // Get form values
        const phone = document.getElementById('phone').value;
        const phone1 = document.getElementById('phone1').value;

        // Validate phone numbers
        if (!validatePhone(phone)) {
          alert('Please enter an 11-digit phone number for your phone');
          return;
        }

        if (!validatePhone(phone1)) {
          alert('Please enter an 11-digit phone number for customer phone');
          return;
        }

        // Clean phone numbers
        const cleanPhone = phone.replace(/\D/g, '');
        const cleanPhone1 = phone1.replace(/\D/g, '');

        // Prepare payment data
        const paymentData = {
          company: document.getElementById('company').value,
          phone: cleanPhone,
          password: document.getElementById('password').value,
          serviceType: document.getElementById('serviceType').value,
          name: document.getElementById('name').value,
          phone1: cleanPhone1,
          amount1: parseFloat(document.getElementById('amount1').value),
          amount2: parseFloat(document.getElementById('amount2').value),
          amount3: parseFloat(document.getElementById('amount3').value),
          method: document.getElementById('method').value,
          trxid: document.getElementById('trxid').value
        };

        try {
          const response = await fetch('https://otpgen-84pg.onrender.com/payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(paymentData)
          });

          const result = await response.json();

          if (response.ok) {
            document.getElementById('confirmation-message').innerHTML = `
              <p style="color: green;">✅ Payment submitted successfully!</p>
            `;
            // Clear form after successful submission
            document.getElementById('payment-form').reset();
            amount3.value = '';
            
            // Redirect to dashboard after 3 seconds
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 3000);
          } else {
            document.getElementById('confirmation-message').innerHTML = `
              <p style="color: red;">❌ ${result.message || 'Payment failed. Please try again.'}</p>
            `;
          }
        } catch (error) {
          console.error('Payment error:', error);
          document.getElementById('confirmation-message').innerHTML = `
            <p style="color: red;">❌ Network error. Please check your connection and try again.</p>
          `;
        }
      });
    });
  </script>
</body>
</html>
