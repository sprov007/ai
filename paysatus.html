<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/main.css">
</head>
<body class="is-preload">

  <header id="header">
    <h1>Payment Status</h1>
    <p>
      тЬЕ ржЖржкржирж╛рж░ ржкрзЗржорзЗржирзНржЯ рж╕ржлрж▓ржнрж╛ржмрзЗ ржЬржорж╛ рж╣рзЯрзЗржЫрзЗред ржкрзНрж░рж╕рзЗрж╕рж┐ржВ ржЪрж▓ржЫрзЗ...<br>
      тП│ рж╕рж░рзНржмрзЛржЪрзНржЪ рзм ржШржгрзНржЯрж╛рж░ ржоржзрзНржпрзЗ ржХрж╛ржЬ рж╕ржорзНржкржирзНржи рж╣ржмрзЗ ржЕржержмрж╛ ржЕрж░рзНрже ржлрзЗрж░ржд ржжрзЗржУрзЯрж╛ рж╣ржмрзЗред
    </p>
  </header>

  <section>
    <h3>ржЖржкржирж╛рж░ ржЬржорж╛ржХрзГржд рждржерзНржп</h3>
    <ul id="submitted-info">
      <!-- Filled by script -->
    </ul>

    <h3>ржкрзНрж░рж╕рзЗрж╕рж┐ржВ ржХрж╛ржЙржирзНржЯржбрж╛ржЙржи</h3>
    <p id="timer" style="font-size: 1.5em; font-weight: bold; color: #1cb495;">Processing: 06:00:00 тП│</p>
  </section>

  <footer>
    <p>
      ЁЯХР ржжржпрж╝рж╛ ржХрж░рзЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржиред ржпржжрж┐ рж╕ржоржпрж╝рзЗрж░ ржоржзрзНржпрзЗ ржХрж╛ржЬ рж╕ржорзНржкржирзНржи ржирж╛ рж╣ржпрж╝, ржЖржкржирж╛рж░ ржкрзЗржорзЗржирзНржЯ рж░рж┐ржлрж╛ржирзНржб ржХрж░рж╛ рж╣ржмрзЗред<br>
      тЬЕ ржзржирзНржпржмрж╛ржж ржЖржкржирж╛рж░ ржмрж┐рж╢рзНржмрж╛рж╕ ржПржмржВ рж╕рж╣рзНржпрж╢рзАрж▓рждрж╛рж░ ржЬржирзНржпред
    </p>
  </footer>

 <script>
document.addEventListener('DOMContentLoaded', async () => {
  // 1. Verify JWT token first
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = 'login.html';
    return;
  }

  // 2. Fetch payment data from server instead of localStorage
  try {
    const response = await fetch('https://otpgen-84pg.onrender.com/last-payment', {
      headers: { 'Authorization': token }
    });

    if (!response.ok) throw new Error('Payment data fetch failed');
    
    const paymentData = await response.json();
    populatePaymentDetails(paymentData);
    startCountdown(paymentData.createdAt);
    
  } catch (error) {
    console.error(error);
    alert('Payment data loading failed');
    window.location.href = 'dashboard.html';
  }
});

function populatePaymentDetails(data) {
  // Filter sensitive fields
  const allowedFields = ['company', 'phone', 'name', 'trxid', 'amount3'];
  const infoList = document.getElementById('submitted-info');
  
  allowedFields.forEach(key => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${key.toUpperCase()}:</strong> ${data[key] || 'N/A'}`;
    infoList.appendChild(li);
  });
}

function startCountdown(createdAt) {
  // Server-side timestamp based countdown
  const expiryTime = new Date(createdAt).getTime() + (6 * 60 * 60 * 1000);
  
  function update() {
    const now = Date.now();
    const remaining = expiryTime - now;

    if (remaining <= 0) {
      document.getElementById('timer').innerHTML = 
        'тП░ рж╕ржорзЯ рж╢рзЗрж╖! ржХрж╛ржЬ ржирж╛ рж╣рж▓рзЗ рж░рж┐ржлрж╛ржирзНржб рж╢рзБрж░рзБ рж╣ржмрзЗред';
      clearInterval(timer);
      return;
    }

    const hours = Math.floor(remaining / (1000 * 60 * 60));
    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

    document.getElementById('timer').innerHTML = 
      `Processing: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} тП│`;
  }

  const timer = setInterval(update, 1000);
  update();
}
</script>

</body>
</html>
